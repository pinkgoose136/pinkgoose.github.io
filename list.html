<!DOCTYPE html>
<html>
<head>
    <title>Telegram Explorer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <div id="head_search">
        <div class="container">
            <img class="left-button" src="https://pinkgoose.pythonanywhere.com/static/search.png">
            <input id="search" class="input-field" oninput="searchInput(this)" placeholder="Введите запрос">
            <img class="right-button" id="toggleButton" src="https://pinkgoose.pythonanywhere.com/static/strelka.png">
        </div>

        <div id="additional_sets" style="display: none;">
            <label for="category">Категории:</label>
            <select id="categorySelect" onchange="addCategory(this.value)"></select>
            <div id="categoryList"></div><br>
        </div>
    </div>
    <div id="keysList"></div>

    <div class="radio-group">
        <div id="center_radio">
            <div class="radio-block">
                <input type="radio" id="option1" name="radios" value="channels" checked>
                <label for="option1">Каналы</label>
              </div>
              <div class="radio-block">
                <input type="radio" id="option2" name="radios" value="groups">
                <label for="option2">Группы</label>
              </div>
              <div class="radio-block">
                  <input type="radio" id="option3" name="radios" value="bots">
                  <label for="option3"> Боты</label>
              </div>
              <div class="radio-block">
                  <input type="radio" id="option4" name="radios" value="stickers">
                  <label for="option4"> Стикерпаки</label>
                </div>
              <div class="radio-block">
                  <input type="radio" id="option5" name="radios" value="emoji">
                  <label for="option5"> Эмодзи</label>
              </div>
        </div>
    </div>
    

    <h2 id="opa"></h2>
    <h3 id="sus"></h3>
    <script>
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        var aValue = getParameterByName('type');

        document.getElementById('toggleButton').addEventListener('click', function() {
            var additionalSets = document.getElementById('additional_sets');
            if (additionalSets.style.display === 'none') {
                additionalSets.style.display = 'block';
                this.classList.toggle('rotated');
            } else {
                additionalSets.style.display = 'none';
            }
        });

        function searchInput(inputElement){
            var tagText = inputElement.value;

            const radioButtons = document.querySelectorAll('input[type="radio"]');
            let selectedValue = '';

            radioButtons.forEach((radio) => {
                if (radio.checked) {
                selectedValue = radio.value;
                }
            });

            generate(tagText, selectedValue)
        }

        const radioButtons = document.querySelectorAll('input[type="radio"]');
        radioButtons.forEach((radio) => {
            radio.addEventListener('change', (event) => {
                generate(0, event.target.value)
            });
        });

    </script>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        function generate(sear, type){
            let keysListDiv = document.getElementById('keysList');
            keysListDiv.innerHTML = "";
            tg.CloudStorage.getKeys(function(err, keys) {
            if (err) {
                document.getElementById('opa').innerHTML = 'Ошибка получения ключей: ' + err;
            } else {
                tg.CloudStorage.getItems(keys, function(err, items) {
                    if (err) {
                        document.getElementById('opa').innerHTML = 'Ошибка получения значений: ' + err;
                    } else {
                        let keysBySecondPart = {};

                        Object.keys(items).forEach(function(key) {
                            let value = items[key];
                            let keyParts = key.split('-');

                            if (keyParts[0] === 'item') {
                                let secondPart = keyParts[1];

                                if (!keysBySecondPart[secondPart]) {
                                    keysBySecondPart[secondPart] = [];
                                }

                                keysBySecondPart[secondPart].push(key);
                            }
                        });

                        Object.keys(keysBySecondPart).forEach(function(secondPart) {
                            let keysDiv = document.createElement('div');
                            keysDiv.classList.add('item');

                            tg.CloudStorage.getItems(keysBySecondPart[secondPart], function(err, itemss) {
                                if (err) {
                                    keysDiv.textContent = 'Ошибка получения значений: ' + err;;
                                    keysListDiv.appendChild(keysDiv);
                                } else {
                                    let itms = {}
                                    let ae = ''
                                    Object.keys(itemss).forEach(function(key2) {
                                        let valu2 = itemss[key2];
                                        let keyParts = key2.split('-');
                                        let tex = "";
                                        let keyy = "";
                                        switch (keyParts[2]) {
                                        case 'link': tex = ''; keyy = '1'; break;
                                        case 'name': tex = ''; keyy = '-1'; break;
                                        case 'desc': tex = ''; keyy = '3'; break;
                                        case 'type': tex = ""; keyy = '2'; break;
                                        case 'cat': tex = "Категории: "; keyy = '4'; break;
                                        case 'tag': tex = "Теги: "; keyy = '5'; break;
                                        case 'owner': tex = "Айди автора: "; keyy = '6'; break;
                                        case 'img': tex = ""; keyy = '11'; ae = valu2; break;
                                        default: tex = expr; keyy = '0'; break;
                                        }
                                        
                                        itms[keyy] = tex + valu2;
                                    });
                                    console.log(type)
                                    console.log(itms['2'])
                                    if (itms['2'] == type){
                                        function ge(){
                                            var head = document.createElement('div');
                                            head.classList.add('head');
                                            var left = document.createElement('div');
                                            left.classList.add('left');
                                            var right = document.createElement('div');
                                            right.classList.add('right');

                                            var imgElement = document.createElement('img');
                                            imgElement.classList.add('img');
                                            imgElement.src = "https://pinkgoose.pythonanywhere.com/static/empty.png"
                                            imgElement.alt = 'Alternative text';


                                            let title = document.createElement('div');
                                            let ssil = document.createElement('a');
                                            ssil.href = itms['1'];
                                            ssil.classList.add('lnk');
                                            ssil.textContent = itms['-1']; 
                                            title.appendChild(ssil);
                                            var desc = document.createElement('div');
                                            desc.textContent = itms['3']; 


                                            left.appendChild(imgElement);
                                            right.appendChild(title);
                                            right.appendChild(desc);
                                            head.appendChild(left);
                                            head.appendChild(right);

                                            keysDiv.appendChild(head);
                                            
                                            Object.keys(itms).forEach(function(i){
                                                if (i == '4' || i == '5'){
                                                    let itemDiv = document.createElement('div');
                                                    itemDiv.textContent = itms[i];
                                                    keysDiv.appendChild(itemDiv);
                                                }
                                            });
                                            keysListDiv.appendChild(keysDiv);
                                            }

                                            if (sear != 0){
                                                if (itms['-1'].includes(sear)){
                                                    ge()
                                                }
                                            }
                                            else{
                                                ge()
                                            }
                                            console.log(itms[-1])
                                            console.log(sear)
                                    }
                                }
                            });
                        });
                    }
                });
            }
        });
        }
        generate(0, 'channels')

    </script>

</body>
</html>
