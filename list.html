<!DOCTYPE html>
<html>
<head>
    <title>Telegram Explorer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="script.js"></script>
</head>
<body>
    <div id="head_search">
        <div class="container">
            <svg  class="left-button"  xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle id="ccircle" cx="11" cy="11" r="8" />
                <line id="cline" x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>

            <input id="search" class="input-field" oninput="searchInput(this)" placeholder="Введите запрос">

            <svg class="right-button" id="toggleButton"  xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline id="cpolyline" points="9 18 15 12 9 6" />
            </svg>
        </div>

        <div id="additional_sets" style="display: none;">
            <label for="category">Категории:</label>
            <select id="categorySelect" onchange="addCategory2(this.value)"></select>
            <div id="categoryList"></div><br>
        </div>
    </div>
    <div id="keysList"></div>

    <div class="radio-group">
        <div id="center_radio">
            <div class="radio-block">
                <input type="radio" id="option1" name="radios" value="channels" checked>
                <label class="labell" for="option1">Каналы</label>
              </div>
              <div class="radio-block">
                <input type="radio" id="option2" name="radios" value="groups">
                <label class="labell" for="option2">Группы</label>
              </div>
              <div class="radio-block">
                  <input type="radio" id="option3" name="radios" value="bots">
                  <label class="labell" for="option3"> Боты</label>
              </div>
              <div class="radio-block">
                  <input type="radio" id="option4" name="radios" value="stickers">
                  <label class="labell" for="option4"> Стикерпаки</label>
                </div>
              <div class="radio-block">
                  <input type="radio" id="option5" name="radios" value="emoji">
                  <label class="labell" for="option5"> Эмодзи</label>
              </div>
        </div>
    </div>
    <script>
        let circle = document.getElementById('ccircle');
        circle.setAttribute('color', 'var(--tg-theme-link-color, #0078d4)');

        let line = document.getElementById('cline');
        line.setAttribute('color', 'var(--tg-theme-link-color, #0078d4)');

        let polyline = document.getElementById('cpolyline');
        polyline.setAttribute('color', 'var(--tg-theme-link-color, #0078d4)');

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        var aValue = getParameterByName('type');

        document.getElementById('toggleButton').addEventListener('click', function() {
            var additionalSets = document.getElementById('additional_sets');
            this.classList.toggle('rotated');
            if (additionalSets.style.display === 'none') {
                additionalSets.style.display = 'block';
            } else {
                additionalSets.style.display = 'none';
            }
        });

        
        let timer;

        function searchInput(inputElement) {
            clearTimeout(timer);

            timer = setTimeout(function() {
                var tagText = inputElement.value;
                const radioButtons = document.querySelectorAll('input[type="radio"]');
                let selectedValue = '';

                radioButtons.forEach((radio) => {
                    if (radio.checked) {
                        selectedValue = radio.value;
                    }
                });
                generate(tagText, selectedValue, []);
            }, 1000);
        }

        const radioButtons = document.querySelectorAll('input[type="radio"]');
        radioButtons.forEach((radio) => {
            radio.addEventListener('change', (event) => {
                create_drop(tg, event.target.value, [])
                generate(0, event.target.value, [])
            });
        });

    </script>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        console.log(tg.initDataUnsafe)
        let idd = tg.initDataUnsafe.language_code;
        console.log(idd)

        function generate(sear, type, ctgss){
            let keysListDiv = document.getElementById('keysList');
            keysListDiv.innerHTML = "";
            tg.CloudStorage.getKeys(function(err, keys) {
            if (err) {
                console.log('Ошибка получения ключей: ' + err);
            } else {
                tg.CloudStorage.getItems(keys, function(err, items) {
                    if (err) {
                        console.log('Ошибка получения значений: ' + err);
                    } else {
                        let keysBySecondPart = {};
                        let itims = [];
                        Object.keys(items).forEach(function(key) {
                            let value = items[key];
                            let keyParts = key.split('-');

                            if (keyParts[0] === 'item') {
                                let secondPart = keyParts[1];

                                if (!keysBySecondPart[secondPart]) {
                                    keysBySecondPart[secondPart] = {};
                                }
                                keysBySecondPart[secondPart][key] = value;
                            }
                        });

                        Object.keys(keysBySecondPart).forEach(function(secondPart) {
                            let itms = {}
                            let ae = ''
                            Object.keys(keysBySecondPart[secondPart]).forEach(function(key2){
                                let valu2 = keysBySecondPart[secondPart][key2];
                                let keyParts = key2.split('-');
                                let tex = "";
                                let keyy = "";
                                switch (keyParts[2]) {
                                    case 'link': tex = ''; keyy = '1'; break;
                                    case 'name': tex = ''; keyy = '-1'; break;
                                    case 'desc': tex = ''; keyy = '3'; break;
                                    case 'type': tex = ""; keyy = '2'; break;
                                    case 'cat': tex = ""; keyy = '4'; break;
                                    case 'tag': tex = ""; keyy = '5'; break;
                                    case 'owner': tex = "Айди автора: "; keyy = '6'; break;
                                    case 'img': tex = ""; keyy = '11'; ae = valu2; break;
                                    default: tex = expr; keyy = '0'; break;
                                }
                                itms[keyy] = tex + valu2;
                            })
                            if (itms['2'] == type && ctgss.every(item => itms['4'].split(', ').includes(item))){
                                if (sear != 0){
                                    if (itms['-1'].toLowerCase().includes(sear.toLowerCase())){
                                        itms['001'] = '2'
                                        itims.push(itms)
                                    }
                                    else if(itms['5'].toLowerCase().split(', ').includes(sear.toLowerCase())){
                                        itms['001'] = '1'
                                        itims.push(itms)
                                    }
                                }
                                else{
                                    itms['001'] = '1'
                                    itims.push(itms)
                                }
                            }
                        });

                        let kes = itims.sort((a, b) => b['001'] - a['001'])

                        kes.forEach((itms) => {
                            let keysDiv = document.createElement('div');
                            keysDiv.classList.add('item');

                            var head = document.createElement('div');
                            head.classList.add('head');
                            var left = document.createElement('div');
                            left.classList.add('left');
                            var right = document.createElement('div');
                            right.classList.add('right');

                            var imgElement = document.createElement('img');
                            imgElement.classList.add('img');
                            imgElement.src = "https://pinkgoose.pythonanywhere.com/static/empty.png"
                            imgElement.alt = 'Alternative text';

                            let title = document.createElement('div');
                            let ssil = document.createElement('a');
                            ssil.href = itms['1'];
                            ssil.classList.add('lnk');
                            ssil.textContent = itms['-1']; 
                            title.appendChild(ssil);
                            var desc = document.createElement('div');
                            desc.textContent = itms['3']; 


                            left.appendChild(imgElement);
                            right.appendChild(title);
                            right.appendChild(desc);
                            head.appendChild(left);
                            head.appendChild(right);

                            keysDiv.appendChild(head);

                            
                            let itemDiv2 = document.createElement('div');
                            itemDiv2.classList.add('catstyle');
                            let tagis2 = itms['4'].split(', ');
                            tagis2.forEach((tt) => {
                                let kr = document.createElement('div');
                                kr.classList.add('itim');
                                kr.textContent = tt + ',';
                                kr.addEventListener('click', function(event) {
                                    addCategory2(event.target.textContent)
                                });
                                itemDiv2.appendChild(kr);
                            })
                            keysDiv.appendChild(itemDiv2);

                            let itemDiv = document.createElement('div');
                            itemDiv.classList.add('tagstyle');
                            let tagis = itms['5'].split(', ');
                            tagis.forEach((t) => {
                                let kr = document.createElement('div');
                                kr.classList.add('itim');
                                kr.textContent = '#'+t + ' ';
                                itemDiv.appendChild(kr);
                            })

                            keysDiv.appendChild(itemDiv);
                            keysListDiv.appendChild(keysDiv)
                        });
                    }
                });
            }
        });
        }
        create_drop(tg, 'channels', [])
        generate(0, 'channels', [])
        
        function addCategory2(vali) {
            let valw = vali.replace(',', '')
            var categorySelect = document.getElementById('categorySelect');
            var selectedCategory = valw;

            let options = categorySelect.options;
            let found = -1;
            for (let i = 0; i < options.length; i++) {
                if (options[i].textContent === valw) {
                    found = i;
                    break;
                }
            }
            console.log(found)

            var categoryList = document.getElementById('categoryList');

            const radioButtons = document.querySelectorAll('input[type="radio"]');
            let selectedValue = '';

            radioButtons.forEach((radio) => {
                if (radio.checked) {
                selectedValue = radio.value;
                }
            });

            if (selectedCategory && categoryList.childElementCount < 3) {
                var categoryItem = document.createElement('div');
                categoryItem.textContent = selectedCategory;
                categoryItem.classList.add('category');
                categoryItem.onclick = function() {
                    categoryList.removeChild(categoryItem);
                    categorySelect.options.add(new Option(categoryItem.textContent, categoryItem.textContent));
                    categorySelect.value = '';
                    let ct = categoryList.innerHTML;

                    let ce = ct.split('<div class="category">')
                    let cetl = []
                    ce.forEach(element => {
                        cetl.push(element.split('</div>')[0])
                    });
                    cetl.shift(); 
                    generate(0, selectedValue, cetl)
                };

                categoryList.appendChild(categoryItem);
                categorySelect.options.remove(found);
                categorySelect.value = '';
                let ct = categoryList.innerHTML;

                let ce = ct.split('<div class="category">')
                let cetl = []

                ce.forEach(element => {
                    cetl.push(element.split('</div>')[0])
                });
                cetl.shift(); 
                generate(0, selectedValue, cetl)

            }
        }

    </script>

</body>
</html>
