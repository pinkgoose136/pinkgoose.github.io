<!DOCTYPE html>
<html>
<head>
    <title>Telegram Explorer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="script.js"></script>
</head>
<body>
    <div id="close"></div>
    <div id="keysList2"></div>
    <h2 id="opa"></h2>
    <h3 id="sus"></h3>
    <script>
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
    </script>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let idd = tg.initDataUnsafe.user.id;
        tg.CloudStorage.getKeys(function(err, keys) {
            if (err) {
                document.getElementById('opa').innerHTML = 'Ошибка получения ключей: ' + err;
            } else {
                let ke = keys.filter(word => word.includes(String(idd)))
                tg.CloudStorage.getItems(keys, function(err, items) {
                    if (err) {
                        document.getElementById('opa').innerHTML = 'Ошибка получения значений: ' + err;
                    } else {
                        let keysBySecondPart = {};

                        Object.keys(items).forEach(function(key) {
                            let value = items[key];
                            let keyParts = key.split('-');

                            if (keyParts[0] === 'item') {
                                let secondPart = keyParts[1];

                                if (!keysBySecondPart[secondPart]) {
                                    keysBySecondPart[secondPart] = [];
                                }

                                keysBySecondPart[secondPart].push(key);
                            }
                        });

                        let keysListDiv = document.getElementById('keysList2');
                        Object.keys(keysBySecondPart).forEach(function(secondPart) {
                            let keysDiv = document.createElement('div');
                            keysDiv.classList.add('item');

                            tg.CloudStorage.getItems(keysBySecondPart[secondPart], function(err, itemss) {
                                if (err) {
                                    keysDiv.textContent = 'Ошибка получения значений: ' + err;;
                                    keysListDiv.appendChild(keysDiv);
                                } else {
                                    let itms = {}
                                    let ae = ''
                                    Object.keys(itemss).forEach(function(key2) {
                                        let valu2 = itemss[key2];
                                        let keyParts = key2.split('-');
                                        let tex = "";
                                        let keyy = "";
                                        keysDiv.id = keyParts[1];
                                        switch (keyParts[2]) {
                                        case 'link': tex = ''; keyy = '1'; break;
                                        case 'name': tex = ''; keyy = '-1'; break;
                                        case 'desc': tex = ''; itms['333'] = key2; keyy = '3'; break;
                                        case 'type': tex = ''; keyy = '2'; break;
                                        case 'cat': tex = "Категории: "; itms['666'] = key2; itms['66'] = valu2; keyy = '4'; break;
                                        case 'tag': tex = "Теги: "; itms['555'] = key2; itms['55'] = valu2;  keyy = '5'; break;
                                        case 'img': tex = ""; keyy = '11'; ae = valu2; break;
                                        default: tex = expr; keyy = '0'; break;
                                        }
                                        
                                        itms[keyy] = tex + valu2;
                                    });
                                    const svgContainer = document.createElement('div');
                                    svgContainer.classList.add('rght');
                                    const svgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                                    svgElement.setAttribute('width', '100');
                                    svgElement.setAttribute('height', '100');
                                    svgElement.setAttribute('viewBox', '0 0 100 100');

                                    const circle1 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                                    circle1.setAttribute('cx', '10');
                                    circle1.setAttribute('cy', '10');
                                    circle1.setAttribute('r', '10');

                                    const circle2 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                                    circle2.setAttribute('cx', '10');
                                    circle2.setAttribute('cy', '35');
                                    circle2.setAttribute('r', '10');

                                    const circle3 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                                    circle3.setAttribute('cx', '10');
                                    circle3.setAttribute('cy', '60');
                                    circle3.setAttribute('r', '10');

                                    svgElement.appendChild(circle1);
                                    svgElement.appendChild(circle2);
                                    svgElement.appendChild(circle3);

                                    svgContainer.appendChild(svgElement);

                                    svgContainer.addEventListener('click', function() {
                                        document.getElementById('popup').style.display = 'flex';
                                        document.getElementById('close').style.display = 'flex';
                                        document.getElementById('zag').innerHTML = itms['-1'];
                                        document.getElementById('description').value = itms['3'];
                                        create_drop(itms['2'], itms['66'].split(', '));
                                        createTag(itms['55'].split(', '));
                                        createCat(itms['66'].split(', '));
                                        
                                        document.getElementById('deleteButton').addEventListener('click', function() {
                                            document.getElementById('popup').style.display = 'none';
                                            document.getElementById('close').style.position = 'fixed';
                                            
                                            document.getElementById('delete_no').addEventListener('click', function() {
                                                document.getElementById('delete_popup').style.display = 'none';
                                                document.getElementById('popup').style.display = 'flex';
                                                document.getElementById('close').style.position = 'relative';
                                            });
                                            document.getElementById('delete_yes').addEventListener('click', function() {
                                                document.getElementById('close').style.position = 'relative';
                                                document.getElementById('popup').style.display = 'none';
                                                document.getElementById('delete_popup').style.display = 'none';
                                                let itmsdel = Object.keys(itemss)
                                                itmsdel.forEach(function(key) {
                                                    tg.CloudStorage.removeItem(key, function(err) {
                                                        if (err) {
                                                            console.log('Ошибка удаления элемента с ключом ' + key + ':' + err);
                                                        } else {
                                                            console.log('Элемент с ключом ' + key + ' успешно удален из хранилища');
                                                        }
                                                    });
                                                });
                                                let Itmsdel2 = document.getElementById(itmsdel[0].split('-')[1]);
                                                Itmsdel2.remove();
                                            });
                                        });

                                        document.getElementById('closeButton').addEventListener('click', function() {
                                            document.getElementById('popup').style.display = 'none';
                                            document.getElementById('close').style.position = 'relative';
                                        });
                                        document.getElementById('saveButton').addEventListener('click', function() {
                                            let des = document.getElementById('description').value;
                                            let ct = document.getElementById('categoryList').innerHTML;
                                            let t = document.getElementById('tagList').innerHTML;

                                            let te = t.split('<div class="tag">')
                                            let tetl = []
                                            te.forEach(element => {
                                                tetl.push(element.split('</div>')[0])
                                            });
                                            let removedElement = tetl.shift();
                                            let tttt = tetl.join(', ');


                                            let ce = ct.split('<div class="category">')
                                            let cetl = []
                                            ce.forEach(element => {
                                                cetl.push(element.split('</div>')[0])
                                            });
                                            let cemovedElement = cetl.shift();
                                            let cccc = cetl.join(', ');

                                            let valuesList = {
                                                desc: des,
                                                cat: cccc,
                                                tag: tttt,
                                            }; 

                                            let keysLst = {
                                                desc: itms['333'],
                                                cat: itms['666'],
                                                tag: itms['555'],
                                            } 
                                            
                                        let keys = Object.keys(valuesList);
                                        function saveValues(index) {
                                            if (index < keys.length) {
                                                let key = keys[index];
                                                let value = valuesList[key];

                                                tg.CloudStorage.setItem(keysLst[key], value, function(err) {
                                                    if (err) {
                                                        console.log('aaa')
                                                    } else {
                                                        saveValues(index + 1);
                                                    }
                                                });
                                            } else {
                                                console.log('ar')
                                            }
                                        }
                                        saveValues(0);

                                        document.getElementById('popup').style.display = 'none';
                                        });
                                    });

                                    var head = document.createElement('div');
                                    head.classList.add('head');
                                    var left = document.createElement('div');
                                    left.classList.add('left');
                                    var right = document.createElement('div');
                                    right.classList.add('right');

                                    
                                    var imgElement = document.createElement('img');
                                    imgElement.classList.add('img');
                                    imgElement.src = "https://pinkgoose.pythonanywhere.com/static/empty.png"
                                    imgElement.alt = 'Image';


                                    let title = document.createElement('div');
                                    let ssil = document.createElement('a');
                                    ssil.href = itms['1'];
                                    ssil.classList.add('lnk');
                                    ssil.textContent = itms['-1']; 
                                    title.appendChild(ssil);
                                    var desc = document.createElement('div');
                                    desc.textContent = itms['3']; 


                                    left.appendChild(imgElement);
                                    right.appendChild(title);
                                    right.appendChild(desc);
                                    head.appendChild(left);
                                    head.appendChild(right);
                                    head.appendChild(svgContainer);
                                    keysDiv.appendChild(head);
                                    
                                    Object.keys(itms).forEach(function(i){
                                        if (i == '4' || i == '5'){
                                            let itemDiv = document.createElement('div');
                                            itemDiv.textContent = itms[i];
                                            keysDiv.appendChild(itemDiv);
                                        }
                                    });
                                    keysListDiv.appendChild(keysDiv);
                                }
                            });
                        });
                    }
                });
            }
        });

    </script>

<div class="popup" id="popup">
    <div class="popup-content">

    <label id="zag" class="error"></label>

    <label for="description">Описание:</label>
    <textarea name="description" id="description" required minlength="10" maxlength="1000" oninput="adjustTextAreaHeight()"></textarea><br>
    <label id="desc_error" class="error"></label>
    <br>

    <label for="category">Категории:</label>
    <select id="categorySelect" onchange="addCategory(this.value)"></select>
    <div id="categoryList"></div><br>
    <label id="cts_error" class="error"></label>
    <br>
    
    <label for="tags">Теги:</label>
    <input type="text" id="tagInput" oninput="addTagOnComma(this)" placeholder="Добавьте теги через запятую"><br>
    <div id="tagList"></div><br>
    <label id="tgs_error" class="error"></label>
    <br>
        <div id="buttons_menu">
            <div id="top_btns_menu">
                <button class="menu_button" id="saveButton">Сохранить</button>
                <button class="menu_button" id="closeButton">Отменить</button>
            </div>
            <button class="menu_button" id="deleteButton">Удалить</button>
        </div>
      
    </div>
</div>

<div class="popup" id="delete_popup">
    <div id="delete_popup-content">
    <label id="zag" class="error">Вы уверены, что хотите удалить данный элемент из каталога? Восстановить его будет невозможно</label>
        <div id="delete_buttons_menu">
            <button class="menu_button" id="delete_yes" style="background-color: red;">Да</button>
            <button class="menu_button" id="delete_no" style="background-color: greenyellow;">Нет</button>
        </div>
    </div>
</div>

</body>
</html>