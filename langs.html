<!DOCTYPE html>
<html>
<head>
    <title>Telegram Explorer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="color: aliceblue;">
    <div id="keysList"></div>
    <div id="add_lng">
        <input id="lng_input">
        <button id="lng_commit">Add</button>
    </div>

    <div id="keyse"></div>
    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        let ese = document.getElementById('lng_commit').addEventListener('click', function(){
            tg.CloudStorage.setItem("lng-" + document.getElementById('lng_input').value, '', function(err) {
                if (err) {
                    console.log('error')
                } else {
                    essa()
                }
            });
        });

        function essa(){
        tg.CloudStorage.getKeys(function(err, keys) {
            if (err) {
                console.log('Ошибка получения ключей: ' + err);
            } else {
                let ke = keys.filter(word => word.includes(String('lng')))
                tg.CloudStorage.getItems(ke, function(err, items) {
                    if (err) {
                        console.log('Ошибка получения значений: ' + err);
                    } else {
                        let kese = document.getElementById('keyse')
                        kese.innerHTML = '';
                        Object.keys(items).forEach(function(key) {
                            var head = document.createElement('div');
                            var name = document.createElement('p');
                            var tagList = document.createElement('input');
                            var inp = document.createElement('input');
                            var btn = document.createElement('button');

                            tagList.classList.add('tagList');
                            tagList = items[key]

                            let cts = String(items[key]).split(', ') 

                            name.innerHTML = String(key);
                            head.id = String(key) + '-head';     
                            tagList.id = String(key) + '-tgs';
                            inp.id = String(key) + '-inp';
                            inp.classList.add('addb');
                            btn.id = String(key);
                            btn.innerHTML = "Refresh";

                            btn.addEventListener('click', function(event) {
                                let buttonId = event.target.id;
                                let inpP = document.getElementById(buttonId+'-tgs')
                                let divsInsideInpP = inpP.querySelectorAll('div');
                                let tute = []
                                divsInsideInpP.forEach(function(div) {
                                    tute.push(div.textContent);
                                });

                                tg.CloudStorage.setItem(buttonId, tute.join(', '), function(err) {
                                    if (err) {
                                        console.log('error')
                                    } else {
                                        essa()
                                    }
                                });
                                
                            });
                            
                            inp.addEventListener('input', function(event) {
                                let inputElement = event.target;
                                let inpId = inputElement.id;
                                var tagList = document.getElementById(inpId.replace('-inp', '-tgs'));
                                var tagText = inputElement.value.slice(0, -1);
                                var existingTags = Array.from(tagList.getElementsByClassName('tag')).map(tag => tag.textContent);

                                if (inputElement.value.includes(',') && inputElement.value !== ',') {
                                    if (tagText && !existingTags.includes(tagText)) {
                                        var tagItem = document.createElement('div');
                                        tagItem.textContent = tagText;
                                        tagItem.classList.add('tag');
                                        tagItem.onclick = function() {
                                            tagList.removeChild(tagItem);
                                        };
                                        tagList.appendChild(tagItem);
                                    }
                                    inputElement.value = '';
                                }
                            })


                            head.appendChild(name);
                            head.appendChild(inp);
                            head.appendChild(btn);
                            head.appendChild(tagList);
                            kese.appendChild(head);
                        });
                    }
                })
            }
        });
        }
        essa()
    </script>

</body>
</html>
