<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Планнер недели</title>
    <link rel="stylesheet" href="stl.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="script.js"></script>
</head>
<body>
    <div id="tasks">
        <h1>Планнер недели</h1>

        <div class="color-checkbox" id="colorcheck">
        </div>

        <button type="button" id="taskAdd" onclick="openModal('new')">Добавить задание</button>

    </div>

    <table>
        <tr id="th1">
            <th></th>
            <th>Понедельник</th>
            <th>Вторник</th>
            <th>Среда</th>
            <th>Четверг</th>
            <th>Пятница</th>
            <th>Суббота</th>
            <th>Воскресенье</th>
        </tr>

        <tr id="th2" style="display: none;">
            <th></th>
            <th>Пн.</th>
            <th>Вт.</th>
            <th>Ср.</th>
            <th>Чт.</th>
            <th>Пт.</th>
            <th>Сб.</th>
            <th>Вс.</th>
        </tr>
    </table>

    <div style="display: none;">
        <button onclick="save()">Сохранить</button>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div>
                <label for="textInput">Название задания:</label>
                <input type="text" id="textInput" name="textInput">    
            </div>

            <div>
                <label for="colorInput">Цвет:</label>
                <input id="colorInput" name="colorInput" type="color">    
            </div>

            <div>
                <button id="btnch" onclick="saveChanges()">Сохранить изменения</button>

                <button id="btnDel" onclick="handleDeleteClick(event)" class="edt">Удалить задание</button>
            </div>

        </div>

    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.setText("Confirm");
        tg.MainButton.show()

        Telegram.WebApp.onEvent('mainButtonClicked', function(){
            var colorCheckboxes = document.querySelectorAll('.color-checkbox input[type="radio"]')
            var colorList = {};

            colorCheckboxes.forEach(function(checkbox) {
                var color = checkbox.value;
                colorList[color] = {'name': '', 'colors': {}}
                colorList[color]['colors'] = [];
                colorList[color]['name'] = document.getElementById(color+'-name').innerHTML
            });
            var allCells = document.querySelectorAll('td');
            allCells.forEach(function(cell) {
                var color1 = cell.style.backgroundColor;
                if (color1) {
                    var color = rgbToHex(color1);
                    if (color && colorList[color]) {
                        colorList[color]['colors'].push(cell.id);
                        cell.style.backgroundColor = '';
                    }
                }
            });

            tg.sendData(JSON.stringify(colorList));
            tg.close();
        })
    </script>


    <script>

        document.addEventListener('DOMContentLoaded', function() {
            var table = document.querySelector('table');

            for (var i = 0; i < 24; i++) {
                var row = document.createElement('tr');

                for (var j = 0; j < 8; j++) {
                    var cell = document.createElement('td');
                    var div = document.createElement('div');
                    div.className = 'task';
                    div.setAttribute('data-hour', i);
                    
                    if (j == 0){
                        var time = document.createElement('p');
                        time.innerHTML = i + ':00'
                        div.appendChild(time)
                        cell.className = 'time'
                    }
                    else{cell.className = 'clickable'}
                    cell.id = 'c-'+i+'-'+j
                    cell.appendChild(div);
                    row.appendChild(cell);
                }
                table.appendChild(row);
            }
            var mouseDown = false;


            table.addEventListener('mousedown', function() {
                if (event.target.className == 'clickable'){
                    var selectedColor = getSelectedColor();
                    event.target.style.backgroundColor = selectedColor; 
                    mouseDown = true;
                }
            });

            table.addEventListener('touchstart', function(event) {
                if (event.target.className == 'clickable'){
                    var selectedColor = getSelectedColor();
                    event.target.style.backgroundColor = selectedColor; 
                  //  mouseDown = true;
                }
            });

            table.addEventListener('mouseup', function() {
                mouseDown = false;
            });

         //   table.addEventListener('touchend', function(event) {
        //        mouseDown = false;
        //    });

            table.addEventListener('mouseover', function(event) {
                if (event.target.tagName === 'TD' && mouseDown == true && event.target.className == 'clickable') {
                    var selectedColor = getSelectedColor();
                    event.target.style.backgroundColor = selectedColor; 
                }
            });

            var allCells = document.querySelectorAll('td');
            allCells.forEach(function(cell) {
                cell.addEventListener('click', function() {
                    if (event.target.className == 'clickable'){
                        console.log(event.target.className)
                        var selectedColor = getSelectedColor();
                        event.target.style.backgroundColor = selectedColor;
                    }
                });
            });

            function getSelectedColor() {
                var checkedRadio = document.querySelector('input[type="radio"]:checked');
                return checkedRadio ? checkedRadio.value : null;
            }
            fill()

        });
    </script>
</body>
</html>
