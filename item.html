<!DOCTYPE html>
<html>
<head>
    <title>Telegram Explorer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

    <h2 id="opa"></h2>
    <button id="accept">Добавить</button>
    <button id="delete">Удалить</button>
    <h2 id="pa"></h2>

    <script>
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        var idi = getParameterByName('idi');

    </script>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        tg.CloudStorage.getKeys(function(err, keys) {
        if (err) {
            document.getElementById('opa').innerHTML = 'Ошибка получения ключей:' + err;
        } else {
            let ke = keys.filter(word => word.includes(idi))
            tg.CloudStorage.getItems(ke, function(err, values) {
                if (err) {
                    document.getElementById('opa').innerHTML = 'Ошибка получения значений: ' + err;
                } else {
                    document.getElementById('opa').innerHTML = 'Полученные значения: ' + JSON.stringify(values);

                    function removeItemsFromStorage(items) {
                        Object.keys(items).forEach(function(key) {
                            tg.CloudStorage.removeItem(key, function(err) {
                                if (err) {
                                    document.getElementById('pa').innerHTML = 'Ошибка удаления элемента с ключом ' + key + ':' + err;
                                } else {
                                    document.getElementById('pa').innerHTML = 'Элемент с ключом ' + key + ' успешно удален из хранилища';
                                }
                            });
                        });
                    }

                    function addItemsToStorage(items) {
                        Object.keys(items).forEach(function(key) {
                            let updatedKey = 'item-' + key;
                            let value = items[key];

                            tg.CloudStorage.setItem(updatedKey, value, function(err) {
                                if (err) {
                                    document.getElementById('pa').innerHTML = 'Ошибка добвления элемента с ключом ' + key + ':' + err;
                                } else {
                                    document.getElementById('pa').innerHTML = 'Элемент с ключом ' + key + ' успешно добавлен в хранилище';
                                }
                            });

                        });
                    }
  
                    document.getElementById('delete').onclick = function(){
                        removeItemsFromStorage(values);
                        tg.close();
                    }
                    document.getElementById('accept').onclick = function(){
                        addItemsToStorage(values);
                        removeItemsFromStorage(values);
                        tg.close();
                    }
                }
            });

        }
        });

    </script>

</body>
</html>
