<!DOCTYPE html>
<html>
<head>
    <title>Telegram Explorer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="script.js"></script>
</head>
<body>
    <div id="keysList"></div>
    <button id="accept">Добавить</button>
    <button id="delete">Удалить</button>
    <h2 id="pa"></h2>
    <script>
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        var idi = getParameterByName('idi');
        var name = getParameterByName('name');
        var img = getParameterByName('img');
        var imgdel = getParameterByName('imgdel')
    </script>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let idd = tg.initDataUnsafe.user.id;

        let ui = ['accept', 'delete']
        translate(tg, ui, idd)


        tg.CloudStorage.getKeys(function(err, keys) {
        if (err) {
            console.log('Ошибка получения ключей:' + err);
        } else {
            let ke = keys.filter(word => word.includes(idi))
            tg.CloudStorage.getItems(ke, function(err, values) {
                if (err) {
                    console.log('Ошибка получения значений: ' + err);
                } else {
                    let keysListDiv = document.getElementById('keysList');
                    let keysDiv = document.createElement('div');
                    keysDiv.classList.add('item');

                    let itms = {}
                    Object.keys(values).forEach(function(key2) {
                        let valu2 = values[key2];
                        let keyParts = key2.split('-');
                        let tex = "";
                        let keyy = "";
                        switch (keyParts[1]) {
                        case 'link': tex = ""; keyy = '1'; break;
                        case 'desc': tex = "Описание: "; keyy = '3'; break;
                        case 'type': tex = "Тип: "; keyy = '2'; break;
                        case 'cat': tex = "Категории: "; keyy = '4'; break;
                        case 'tag': tex = "Теги: "; keyy = '5'; break;
                        default: tex = ''; keyy = '0'; break;
                        }
                        if (keyy != '0'){
                            itms[keyy] = tex + valu2;    
                        }
                        else{
                            itms['o'] = 'ooo';
                        }
                    });
                    if (String(Object.keys(itms)) == 'o'){
                        console.log('Заявка отправлена на рассмотрение. Ожидайте ответа');
                        let acceptb = document.getElementById('accept');
                        acceptb.remove();
                        let deleteb = document.getElementById('delete');
                        deleteb.remove();
                    }
                    else{
                    var head = document.createElement('div'); head.classList.add('head');
                    var left = document.createElement('div'); left.classList.add('left');
                    var right = document.createElement('div'); right.classList.add('right');

                    var imgElement = document.createElement('img');
                    imgElement.classList.add('img');
                    imgElement.src = "https://pinkgoose.pythonanywhere.com/static/empty.png"
                    imgElement.alt = 'Alternative text';

                    let title = document.createElement('div');
                    let ssil = document.createElement('a');
                    ssil.href = itms['1'];
                    ssil.classList.add('lnk');
                    ssil.textContent = name; 
                    title.appendChild(ssil);
                    var desc = document.createElement('div');
                    desc.textContent = itms['3'].split(', ').join(' #'); 

                    left.appendChild(imgElement);
                    right.appendChild(title);
                    right.appendChild(desc);
                    head.appendChild(left);
                    head.appendChild(right);

                    keysDiv.appendChild(head);
                    
                    Object.keys(itms).forEach(function(i){
                        if (i == '4' || i == '5'){
                            let itemDiv = document.createElement('div');
                            itemDiv.textContent = itms[i];
                            keysDiv.appendChild(itemDiv);
                        }
                    });
                    keysListDiv.appendChild(keysDiv);

                    function removeItemsFromStorage(items) {
                        Object.keys(items).forEach(function(key) {
                            tg.CloudStorage.removeItem(key, function(err) {
                                if (err) {
                                    console.log('Ошибка удаления элемента с ключом ' + key + ':' + err);
                                } else {
                                    console.log('Элемент с ключом ' + key + ' успешно удален из хранилища');
                                }
                            });
                        });
                    }

                    function addItemsToStorage(items) {
                        Object.keys(items).forEach(function(key) {
                            let updatedKey = 'draft-' + key + '-' + String(idd);
                            let value = items[key];

                            tg.CloudStorage.setItem(updatedKey, value, function(err) {
                                if (err) {
                                    console.log('Ошибка добвления элемента с ключом ' + key + ':' + err);
                                } else {
                                    console.log('Элемент с ключом ' + key + ' успешно добавлен в хранилище');
                                }
                            });

                        });
                        let ge = 'draft-' + Object.keys(items)[0].split('-')[0]
                        tg.CloudStorage.setItem(ge + '-name'  + '-' + String(idd), name, function(err) {
                                if (err) {
                                    console.log('Ошибка добвления элемента с ключом ' + ge + '-name' + ':' + err);
                                } else {
                                    console.log('Элемент с ключом ' + ge + '-name' + ' успешно добавлен в хранилище');
                                }
                            });
                        tg.CloudStorage.setItem(ge + '-img' + '-' + String(idd), img, function(err) {
                                if (err) {
                                    console.log('Ошибка добвления элемента с ключом ' + ge + '-img' + ':' + err);
                                } else {
                                    console.log('Элемент с ключом ' + ge + '-img' + ' успешно добавлен в хранилище');
                                }
                            });
                        tg.CloudStorage.setItem(ge + '-imgdel' + '-' + String(idd), imgdel, function(err) {
                                if (err) {
                                    console.log('Ошибка добвления элемента с ключом ' + ge + '-imgdel' + ':' + err);
                                } else {
                                    console.log('Элемент с ключом ' + ge + '-imgdel' + ' успешно добавлен в хранилище');
                                }
                            });
                    }
  
                    document.getElementById('delete').onclick = function(){
                        removeItemsFromStorage(values);
                        tg.close();
                    }
                    document.getElementById('accept').onclick = function(){
                        addItemsToStorage(values);
                        removeItemsFromStorage(values);
                        tg.close();
                    }
                }
            }
            });

        }
        });

    </script>

</body>
</html>
