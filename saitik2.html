<!DOCTYPE html>
<html>
<head>
    <title>Telegram Explorer</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="script.js"></script>
</head>
<body>
    <div id="form">
        <label for="type">Choose the type:</label>
        <select id="typeSelect" onchange="typeChange()">
            <option value="channels">Channel</option>
            <option value="groups">Group</option>
            <option value="bots">Bot</option>
            <option value="stickers">Stickers</option>
            <option value="emoji">Emoji</option>
        </select>
        <br><br>

        <label for="link">Link:</label>
        <input type="text" name="link" id="link" required><br>
        <label id="lnk_error" class="error"></label>
        <br>

        <label for="description">Description:</label>
        <textarea name="description" id="description" required minlength="10" maxlength="1000" oninput="adjustTextAreaHeight()"></textarea><br>
        <label id="desc_error" class="error"></label>
        <br>

        <label for="category">Categories:</label>
        <select id="categorySelect" onchange="addCategory(this.value)"></select>
        <div id="categoryList"></div><br>
        <label id="cts_error" class="error"></label>
        <br>
        
        <label for="tags">Tags:</label>
        <input type="text" id="tagInput" oninput="addTagOnComma(this)" placeholder="Add tags separated by commas"><br>
        <div id="tagList"></div><br>
        <label id="tgs_error" class="error"></label>
        <br>
    </div>
    <script>
        let aValue;
        function typeChange(){
            var typeSelect = document.getElementById('typeSelect');
            var selected = typeSelect.options[typeSelect.selectedIndex].value;
            aValue = selected;
            if (aValue == 'bots'){
                document.getElementById('link').value = "https://t.me/"
            }
            cts_addc(tg, aValue)

        }

        var typeSelect = document.getElementById('typeSelect');
        var selected = typeSelect.options[typeSelect.selectedIndex].value;
        aValue = selected;

        let tg = window.Telegram.WebApp;
        document.addEventListener('DOMContentLoaded',  cts_addc(tg, aValue))

        
        tg.CloudStorage.getItem('lng-ru', function(err, item) {
            if (err) {
                console.log('Ошибка получения значений: ' + err);
            } else {
                let tutu = {};
                let yy = item.split('\n');
                yy.forEach(ee => {
                    let yd = ee.split(':');
                    tutu[yd[0]] = yd[1];
                });

                Object.keys(tutu).forEach(function(rura){
                    const selectElement = document.getElementById('typeSelect');
                    const newOption = document.createElement('option');
                    newOption.value = rura;
                    newOption.text = tutu[rura];
                    console.log(newOption)
                    selectElement.appendChild(newOption);
                })

            }
        });

        tg.expand();
        tg.MainButton.setText("Confirm");
        tg.MainButton.show()

         Telegram.WebApp.onEvent('mainButtonClicked', function(){
         let lnk = document.getElementById('link').value; let des = document.getElementById('description').value;
         let ct = document.getElementById('categoryList').innerHTML; let t = document.getElementById('tagList').innerHTML;
         let te = t.split('<div class="tag">')
         let tetl = []
         te.forEach(element => {
            tetl.push(element.split('</div>')[0])
         });
         let removedElement = tetl.shift();
         let tttt = tetl.join(', ');


         let ce = ct.split('<div class="category">')
         let cetl = []
         ce.forEach(element => {
            cetl.push(element.split('</div>')[0])
         });
         let cemovedElement = cetl.shift();
         let cccc = cetl.join(', ');


         lnke = document.getElementById('lnk_error');  dese = document.getElementById('desc_error');
         ctse = document.getElementById('cts_error');  tgse = document.getElementById('tgs_error');  

         
        tg.CloudStorage.getKeys(function(err, keyse) {
        if (err) {
            console.log('Ошибка получения ключей: ' + err);
        } else {
            let ke = keyse.filter(word => word.split('-')[2] == 'link')
            tg.CloudStorage.getItems(ke, function(err, items) {
            if (err) {
                console.log('Ошибка получения значений: ' + err);
            } else {
                let linkis = Object.values(items)
                if (linkis.includes(lnk)){
                    lnke.innerHTML = 'An element with this link is already stored in the database'
                }
                else{
                    hehe()
                }
            }
            })
            }
        })

        function hehe(){
            lnke.innerHTML = ''; dese.innerHTML = ''; ctse.innerHTML = ''; tgse.innerHTML = ''
            if (!lnk.startsWith('https://t.me/')){lnke.innerHTML = 'Wrong link'}
            else if (des.length < 11 ){dese.innerHTML = 'Description is too short. Minimum 10 symbols'} 
            else if (des.length > 601 ){dese.innerHTML = 'Desciption is too long'}
            else if (String(ct) == '' ){ctse.innerHTML =  'Add atleast 1 category'}
            else if (String(t) == '' ){tgse.innerHTML = 'Add atleast 1 tag'}
            else{
            lnke.innerHTML = ''; dese.innerHTML = ''; ctse.innerHTML = ''; tgse.innerHTML = ''
            function getFormattedDateTime() {
                let currentDate = new Date();
                let day = String(currentDate.getDate()).padStart(2, '0');
                let month = String(currentDate.getMonth() + 1).padStart(2, '0');
                let year = String(currentDate.getFullYear()).slice(2);
                let hours = String(currentDate.getHours()).padStart(2, '0');
                let minutes = String(currentDate.getMinutes()).padStart(2, '0');
                let seconds = String(currentDate.getSeconds()).padStart(2, '0');
                return `${day}${month}${year}${hours}${minutes}${seconds}`;
            }

            let formattedDateTime = getFormattedDateTime();
            let data = {
                link: lnk,
                desc: des,
                type: aValue,
                cat: cccc,
                tag: tttt,
                date: formattedDateTime,
                name: "draft"
            }

            let valuesList = {
                link: lnk,
                desc: des,
                type: aValue,
                cat: cccc,
                tag: tttt,
            }; 

            let keys = Object.keys(valuesList);
            function saveValues(index) {
                if (index < keys.length) {
                    let key = keys[index];
                    let value = valuesList[key];

                    tg.CloudStorage.setItem(String(formattedDateTime) + "-" + key, value, function(err) {
                        if (err) {
                            tg.sendData(JSON.stringify({"error": err + String(formattedDateTime) + "-" + key}));
                            tg.close();
                        } else {
                            saveValues(index + 1);
                        }
                    });
                } else {
                    tg.sendData(JSON.stringify(data));
                    tg.close();
                }
            }
            }

            saveValues(0)
        }

         });
    </script>

</body>
</html>
