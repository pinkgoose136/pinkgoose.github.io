<!DOCTYPE html>
<html>
<head>
    <title>Telegram Explorer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="color: aliceblue;">
    <div id="keysList"></div>
    <h2 id="opa"></h2>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let lnk = []
        function addEl(items){
            Object.keys(items).forEach(function(key) {
                let updatedKey = key.replace("draft", "item");
                let value = items[key];

                tg.CloudStorage.setItem(updatedKey, value, function(err) {
                    if (err) {
                        document.getElementById('pa').innerHTML = 'Ошибка добвления элемента с ключом ' + key + ':' + err;
                    } else {
                        document.getElementById('pa').innerHTML = 'Элемент с ключом ' + key + ' успешно добавлен в хранилище';
                    }
                });

            });
        }

        function delEl(items){
            Object.keys(items).forEach(function(key) {
                tg.CloudStorage.removeItem(key, function(err) {
                    if (err) {
                        document.getElementById('pa').innerHTML = 'Ошибка удаления элемента с ключом ' + key + ':' + err;
                    } else {
                        document.getElementById('pa').innerHTML = 'Элемент с ключом ' + key + ' успешно удален из хранилища';
                    }
                });
            });
        }

        tg.CloudStorage.getKeys(function(err, keys) {
            if (err) {
                document.getElementById('opa').innerHTML = 'Ошибка получения ключей: ' + err;
            } else {
                tg.CloudStorage.getItems(keys, function(err, items) {
                    if (err) {
                        document.getElementById('opa').innerHTML = 'Ошибка получения значений: ' + err;
                    } else {
                        let keysBySecondPart = {};

                        Object.keys(items).forEach(function(key) {
                            let value = items[key];
                            let keyParts = key.split('-');

                            if (keyParts[0] === 'draft') {
                                let secondPart = keyParts[2];

                                if (!keysBySecondPart[secondPart]) {
                                    keysBySecondPart[secondPart] = [];
                                }

                                keysBySecondPart[secondPart].push(key);
                            }
                        });

                        let keysListDiv = document.getElementById('keysList');
                        Object.keys(keysBySecondPart).forEach(function(secondPart) {
                            let keysDiv = document.createElement('div');
                            keysDiv.classList.add('item');

                            tg.CloudStorage.getItems(keysBySecondPart[secondPart], function(err, itemss) {
                                if (err) {
                                    keysDiv.textContent = 'Ошибка получения значений: ' + err;;
                                    keysListDiv.appendChild(keysDiv);
                                } else {
                                    let itms = {}
                                    Object.keys(itemss).forEach(function(key2) {
                                        let valu2 = itemss[key2];
                                        let keyParts = key2.split('-');
                                        let tex = "";
                                        let keyy = "";
                                        switch (keyParts[3]) {
                                        case 'link': tex = "Ссылка: "; keyy = '1'; break;
                                        case 'desc': tex = "Описание: "; keyy = '3'; break;
                                        case 'type': tex = "Тип: "; keyy = '2'; break;
                                        case 'cat': tex = "Категории: "; keyy = '4'; break;
                                        case 'tag': tex = "Теги: "; keyy = '5'; break;
                                        default: tex = expr; keyy = '0'; break;
                                        }
                                        itms[keyy] = tex + valu2;

                                    });
                                    Object.keys(itms).forEach(function(i){
                                        let itemDiv = document.createElement('div');
                                        itemDiv.textContent = itms[i];
                                        keysDiv.appendChild(itemDiv);
                                    });
                                    let button1 = document.createElement('button');
                                    button1.textContent = 'Добавить';
                                    button1.addEventListener('click', function(event) {
                                        addEl(itemss);
                                        delEl(itemss);
                                        let parentElement = event.target.parentNode;
                                        parentElement.parentNode.removeChild(parentElement);
                                    });
                                    keysDiv.appendChild(button1);
                                    lnk.push(itemss)
                                    let button2 = document.createElement('button');
                                    button2.textContent = 'Удалить';
                                    button2.addEventListener('click', function(event) {
                                        delEl(itemss);
                                        let parentElement = event.target.parentNode;
                                        parentElement.parentNode.removeChild(parentElement);
                                    });
                                    keysDiv.appendChild(button2);

                                    keysListDiv.appendChild(keysDiv);
                                }
                            });
                            
                        });
                    }
                });
            }
        });

    </script>
    
    <script>
        tg.MainButton.setText("Завершить");

        tg.MainButton.show()
        Telegram.WebApp.onEvent('mainButtonClicked', function(){

        let data = {
            links: lnk,
            name: "check"
        }

        tg.sendData(JSON.stringify(data));
        tg.close();

        });
    </script>

</body>
</html>
