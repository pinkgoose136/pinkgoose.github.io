<!DOCTYPE html>
<html>
<head>
    <title>Telegram Explorer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="color: aliceblue;">
    <div id="keysList"></div>
    <h2 id="opa"></h2>
    <div id="add_cts">
        <input id="cts_input">
        <button id="cts_commit">Add</button>
    </div>

    <div id="keyse"></div>
    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        let ese = document.getElementById('cts_commit').addEventListener('click', function(){
            tg.CloudStorage.setItem("cts-" + document.getElementById('cts_input').value, '', function(err) {
                if (err) {
                    console.log('error')
                } else {
                    essa()
                }
            });
        });

        function essa(){
        tg.CloudStorage.getKeys(function(err, keys) {
            if (err) {
                document.getElementById('opa').innerHTML = 'Ошибка получения ключей: ' + err;
            } else {
                let ke = keys.filter(word => word.includes(String('cts')))
                tg.CloudStorage.getItems(ke, function(err, items) {
                    if (err) {
                        document.getElementById('opa').innerHTML = 'Ошибка получения значений: ' + err;
                    } else {
                        let keysBySecondPart = {};

                        Object.keys(items).forEach(function(key) {
                            let kese = document.getElementById('keyse')
                            kese.innerHTML = '';

                            var head = document.createElement('div');
                            var tagList = document.createElement('div');
                            var inp = document.createElement('input');
                            var btn = document.createElement('button');

                            tagList.classList.add('tagList');
                            
                            let cts = String(items[key]).split(', ') 
                            
                            cts.forEach(element => {
                                var tagItem = document.createElement('div');
                                tagItem.textContent = element;
                                tagItem.classList.add('tag');
                                tagItem.onclick = function() {
                                    tagList.removeChild(tagItem);
                                };
                                tagList.appendChild(tagItem);
                            });

                            head.id = String(key) + '-head'     
                            tagList.id = String(key) + '-tgs';
                            btn.id = String(key);
                            inp.id = String(key) + '-inp';
                            btn.innerHTML = "Refresh";

                            inp.classList.add('addb');

                            btn.addEventListener('click', function(event) {
                                let buttonId = event.target.id;
                                let inpP = document.getElementById(buttonId+'-tgs')
                                console.log(inpP.value)

                              //  tg.CloudStorage.setItem(buttonId, inpP.value, function(err) {
                               //     if (err) {
                              //          console.log('error')
                              //      } else {
                              //          essa()
                             //       }
                             //   });
                                
                            });


                            head.appendChild(btn);
                            head.appendChild(tagList);
                            kese.appendChild(head);

                            inp.addEventListener('input', function(event) {
                                let inputElement = event.target;
                                let inpId = inputElement.id;
                                var tagList = document.getElementById('tagList' + inpId.replace('-inp', '-tgs'));
                                console.log(tagList)
                                var tagText = inputElement.value.trim();

                                var existingTags = Array.from(tagList.getElementsByClassName('tag')).map(tag => tag.textContent);

                                if (inputElement.value.includes(',') && inputElement.value !== ',') {
                                    if (tagText && !existingTags.includes(tagText)) {
                                        var tagItem = document.createElement('div');
                                        tagItem.textContent = tagText;
                                        tagItem.classList.add('tag');
                                        tagItem.onclick = function() {
                                            tagList.removeChild(tagItem);
                                        };
                                        tagList.appendChild(tagItem);
                                    }
                                    inputElement.value = '';
                                }
                            });

                            let hea = document.getElementById(String(key) + '-head')
                            hea.appendChild(inp);
                            kese.appendChild(hea);
                        });
                    }
                })
            }
        });
        }
        essa()
    </script>

</body>
</html>
